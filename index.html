
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>手機查詢系統 SQLite 版</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <style>
    body { background-color: #0d0d16; color: white; font-family: sans-serif; text-align: center; padding: 2rem; }
    input { padding: 0.6rem; width: 60%; font-size: 1rem; border-radius: 6px; border: none; margin-bottom: 1rem; }
    button { padding: 0.6rem 1.2rem; font-size: 1rem; margin: 0.2rem; border-radius: 6px; border: none; cursor: pointer; }
    .search-btn { background-color: #4fc1e9; }
    .clear-btn { background-color: #f6a623; }
    .result-box {
      background: #2d2d3a;
      padding: 1rem;
      margin: 0.5rem auto;
      width: 70%;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>📱 手機查詢系統（SQLite 離線版）</h1>
  <input type="text" id="searchInput" placeholder="請輸入手機關鍵字，例如 iPhone 256" />
  <br/>
  <button class="search-btn" onclick="search()">搜尋</button>
  <button class="clear-btn" onclick="clearSearch()">清除</button>
  <div id="result" style="margin-top:2rem;"></div>

  <script>
    let db = null;

    // 載入 SQLite 資料庫
    initSqlJs({ locateFile: filename => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${filename}` })
      .then(SQL => {
        fetch("mobilequery_data_split.sqlite")
          .then(res => res.arrayBuffer())
          .then(buf => {
            db = new SQL.Database(new Uint8Array(buf));
          });
      });

    function search() {
      const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";

      if (!keyword || !db) return;

      const phones = db.exec(`
        SELECT * FROM phones WHERE LOWER(機型) LIKE '%${keyword.replace(/'/g, "''")}%'
      `);

      if (phones.length === 0) {
        resultDiv.innerHTML = "<p>找不到符合的手機型號。</p>";
        return;
      }

      phones[0].values.forEach(([代碼, 機型, 單機價, 保險]) => {
        const planRows = db.exec(`SELECT 專案價, 來源頁, 來源欄位 FROM plans WHERE 代碼 = '${代碼.replace(/'/g, "''")}'`);
        const plans = (planRows.length > 0) ? planRows[0].values : [];

        let html = `
          <div class="result-box">
            <strong>${機型}</strong><br/>
            空機價：${單機價} 元<br/>
            保險：${保險 || "無"}<br/>
            <hr/>
            <strong>專案列表：</strong><br/>
        `;
        html += plans.map(p => `📄 ${p[1]}｜${p[2]}：<b>${p[0]} 元</b>`).join("<br/>");
        html += "</div>";
        resultDiv.innerHTML += html;
      });
    }

    function clearSearch() {
      document.getElementById("searchInput").value = "";
      document.getElementById("result").innerHTML = "";
    }
  </script>
</body>
</html>
